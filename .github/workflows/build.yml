name: CI

on:
  pull_request:
  merge_group:
  push:
    branches:
      - master
      - prod
      - testnet
      - acceptance-test-pass
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
  
jobs:

  complete:
    if: always()
    needs: [fmt, cargo-deny, rust-check-git-rev-deps, build]
    runs-on: ubuntu-22.04
    steps:
    - if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')
      run: exit 1

  fmt:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
    - run: rustup component add rustfmt
    - run: rustup update
    - run: cargo fmt --all --check

  cargo-deny:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        checks:
          - advisories
          - bans licenses sources
    # Prevent sudden announcement of a new advisory from failing ci:
    continue-on-error: ${{ matrix.checks == 'advisories' }}
    steps:
    - uses: actions/checkout@v4
    - uses: EmbarkStudios/cargo-deny-action@8d73959fce1cdc8989f23fdf03bec6ae6a6576ef
      with:
        command: check ${{ matrix.checks }}
        # leave arguments empty so we don't test --all-features
        # which will see conflicting env versions
        arguments:

  rust-check-git-rev-deps:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
    - uses: stellar/actions/rust-check-git-rev-deps@main

  build:
    runs-on: ubuntu-jammy-16-cores-amd64
    env:
      CACHED_PATHS: |
        ~/.ccache
        ~/.cargo
        target
    strategy:
      fail-fast: false
      matrix:
        toolchain: [ "gcc", "clang"]
        protocol: ["current", "next"]
        scenario: ["", "--check-test-tx-meta"]
    steps:
      - name: Fix kernel mmap rnd bits
        # Asan in llvm provided in ubuntu 22.04 is incompatible with
        # high-entropy ASLR in much newer kernels that GitHub runners are
        # using leading to random crashes: https://reviews.llvm.org/D148280
        run: sudo sysctl vm.mmap_rnd_bits=28

      # We start with as cheap as possible a cache probe to see if we have an exact hit on this
      # git commit ID (for a given OS/toolchain/protocol). If so we can skip all subsequent
      # steps: we already tested this exact SHA.
      #
      # Unfortunately due to the way github actions control flow works, we have to repeat the
      # step 'if' condition in each step, and cannot actually "exit early" and skip the job.
      # There are a lot of duplicate bug reports filed on this aspect of github actions, don't
      # bother filing another.
      - name: Probe Cache
        id: cache
        uses: actions/cache@v4
        with:
          path: ${{ env.CACHED_PATHS }}
          key: ${{ runner.os }}-${{ matrix.toolchain }}-${{ matrix.protocol }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.toolchain }}-${{ matrix.protocol }}-
            ${{ runner.os }}-${{ matrix.toolchain }}-

      # Clean up older caches from this PR to save space
      - name: Clean up older PR caches
        if: steps.cache.outputs.cache-hit != 'true' && github.event_name == 'pull_request'
        run: |
          echo "Cleaning up older caches for this PR..."
          
          # Get current cache key prefix for this matrix combination
          CACHE_PREFIX="${{ runner.os }}-${{ matrix.toolchain }}-${{ matrix.protocol }}-"
          
          # List all caches for this PR branch, excluding the current one
          CURRENT_KEY="${CACHE_PREFIX}${{ github.sha }}"
          
          # Get cache IDs for this PR branch with same prefix but different SHA
          OLD_CACHE_IDS=$(gh cache list --repo "$GITHUB_REPO" --ref "${{ github.head_ref }}" --limit 50 --json key,id --jq ".[] | select(.key | startswith(\"$CACHE_PREFIX\") and . != \"$CURRENT_KEY\") | .id" 2>/dev/null || echo "")
          
          if [ -n "$OLD_CACHE_IDS" ]; then
            echo "Found old caches to delete:"
            echo "$OLD_CACHE_IDS"
            
            # Delete old caches (ignore failures)
            echo "$OLD_CACHE_IDS" | while read cache_id; do
              if [ -n "$cache_id" ]; then
                echo "Deleting cache ID: $cache_id"
                gh cache delete "$cache_id" --repo "$GITHUB_REPO" 2>/dev/null || true
              fi
            done
            
            echo "Cache cleanup completed"
          else
            echo "No old caches found for cleanup"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO: ${{ github.repository }}
        continue-on-error: true

      - uses: actions/checkout@v4
        if: steps.cache.outputs.cache-hit != 'true'
        with:
           fetch-depth: 200
           submodules: true

      - uses: actions/checkout@v4
        if: steps.cache.outputs.cache-hit != 'true'
        with:
           fetch-depth: 200
           submodules: true
      - name: install core packages
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get -y install --no-install-recommends apt-utils dialog git iproute2 procps lsb-release
      - name: install tool chain
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          sudo apt-get -y install libstdc++-10-dev clang-format-12 ccache lldb
          if test "${{ matrix.toolchain }}" = "gcc" ; then
            sudo apt-get -y install cpp-10 gcc-10 g++-10
          else
            sudo apt-get -y install clang-12 llvm-12
          fi
      - name: install rustup components
        if: steps.cache.outputs.cache-hit != 'true'
        run: rustup component add rustfmt
      - name: install cargo-cache
        if: steps.cache.outputs.cache-hit != 'true'
        run: cargo install --locked cargo-cache --version 0.8.3
      - name: install cargo-sweep
        if: steps.cache.outputs.cache-hit != 'true'
        run: cargo install --locked cargo-sweep --version 0.7.0
      - name: install dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: sudo apt-get -y install postgresql git build-essential pkg-config autoconf automake libtool bison flex libpq-dev parallel libunwind-dev sed perl
      - name: Build
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          if test "${{ matrix.toolchain }}" = "gcc" ; then
            export CC='gcc'
            export CXX='g++'
          else
            export CC='clang'
            export CXX='clang++'
          fi
          echo Build with $CC and $CXX
          ./ci-build.sh --use-temp-db --protocol ${{ matrix.protocol }} ${{ matrix.scenario }}